import { useState } from "react";

/**
 * Nine‑Box Matrix visualiser
 * ---------------------------------------------------------
 * Paste any of these structures into the textbox:
 *  1) 3×3 grid copied from Excel (with or without the row/col headers)
 *  2) Tab‑delimited list of individual projects in « Benefit<TAB>Feas<TAB>Title » form
 *
 * If a cell contains multiple projects separated by commas, semicolons or line‑breaks,
 * the component splits them automatically so each one appears on its own line.
 */

// ---- Helpers -------------------------------------------------------------

/** Convert a 3×3 grid pasted from Excel into a [][] array of strings. */
function parseMatrixFromGrid(raw: string): string[][] | null {
  const rows = raw
    .trim()
    .split(/\r?\n/)
    .map((r) => r.split(/\t|\s{2,}/).filter(Boolean));
  if (rows.length < 3) return null;
  // Remove header row/col if present (detect the word "Benefits" or "High" in top‑left)
  if (/benefits/i.test(rows[0][0]) || rows[0][0] === "") rows.shift();
  if (rows[0].length === 4) rows.forEach((r) => r.shift());
  const safeRows = Array.from({ length: 3 }, (_, i) =>
    Array.from({ length: 3 }, (_, j) => rows[i]?.[j] ?? "")
  );
  return safeRows;
}

/** Convert a line‑based list (Benefit\tFeas\tTitle) into a 3×3 matrix of titles. */
function parseMatrixFromList(raw: string): string[][] {
  const out = Array.from({ length: 3 }, () => Array(3).fill(""));
  const benefitIdx = { High: 0, Medium: 1, Low: 2 } as const;
  const feasIdx = { Low: 0, Medium: 1, High: 2 } as const;
  raw
    .trim()
    .split(/\r?\n/)
    .forEach((line) => {
      const [b, f, ...rest] = line.split(/\t|\s{2,}/);
      const title = rest.join(" ").trim();
      if (benefitIdx[b] !== undefined && feasIdx[f] !== undefined && title) {
        const current = out[benefitIdx[b]][feasIdx[f]];
        out[benefitIdx[b]][feasIdx[f]] = current
          ? `${current}\n${title}`
          : title;
      }
    });
  return out;
}

// ---- Component -----------------------------------------------------------

export default function NineBoxMatrix() {
  const [matrix, setMatrix] = useState<string[][]>([
    ["", "", ""],
    ["", "", ""],
    ["", "", ""],
  ]);

  const handlePaste = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {
    const txt = e.clipboardData.getData("text/plain");
    // 1) Try grid mode
    const grid = parseMatrixFromGrid(txt);
    if (grid) {
      setMatrix(splitMulti(grid));
      e.preventDefault();
      return;
    }
    // 2) Fallback to list mode
    setMatrix(splitMulti(parseMatrixFromList(txt)));
    e.preventDefault();
  };

  // Split commas / semicolons / CR into real line‑breaks inside each cell
  const splitMulti = (mat: string[][]) =>
    mat.map((row) =>
      row.map((cell) =>
        cell
          .split(/[,;\n]+/)
          .map((s) => s.trim())
          .filter(Boolean)
          .join("\n")
      )
    );

  const rowLabels = ["High", "Medium", "Low"];
  const colLabels = ["Low", "Medium", "High"];

  const bgClass = (r: number, c: number) => {
    const score = (3 - r) + (c + 1); // green if 6 / 5, yellow 4, red 3 / 2
    if (score >= 6) return "bg-green-200";
    if (score >= 4) return "bg-yellow-200";
    return "bg-red-200";
  };

  return (
    <div className="p-4 max-w-2xl mx-auto">
      <h1 className="text-xl font-bold mb-2">9-Box Matrix</h1>
      <p className="text-sm mb-4">
        Collez soit la grille 3×3 depuis Excel, soit une liste tabulée
        &nbsp;«&nbsp;Benefit&nbsp;⇥&nbsp;Feas&nbsp;⇥&nbsp;Titre&nbsp;».
      </p>
      <textarea
        onPaste={handlePaste}
        placeholder="Coller ici…"
        className="w-full h-28 p-2 border rounded mb-6"
      />

      <div className="grid grid-cols-4 gap-px text-sm">
        <div></div>
        {colLabels.map((c) => (
          <div key={c} className="text-center font-semibold">
            {c}
          </div>
        ))}
        {rowLabels.map((rLbl, rIdx) => (
          <>
            <div key={rLbl} className="flex items-center justify-center font-semibold">
              {rLbl}
            </div>
            {colLabels.map((_, cIdx) => (
              <div
                key={`${rIdx}-${cIdx}`}
                className={`${bgClass(
                  rIdx,
                  cIdx
                )} min-h-[70px] whitespace-pre-wrap p-2 border`}
              >
                {matrix[rIdx][cIdx]}
              </div>
            ))}
          </>
        ))}
      </div>
    </div>
  );
}
